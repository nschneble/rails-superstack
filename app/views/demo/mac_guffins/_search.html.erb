<%= turbo_frame_tag "mac-guffin-search" do %>
  <% if @search_unavailable %>
    <p class="mx-4 sm:mx-0 mt-2 text-sm text-amber-200">Search index isn't ready. Run <code>bin/rails typesense:reindex</code>.</p>
  <% end %>

  <% if @pagy.pages > 1 %>
    <div class="mx-4 sm:mx-0 mt-4 mb-4 flex justify-center">
      <%== @pagy.series_nav %>
    </div>
  <% end %>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 sm:gap-4 mx-4 sm:mx-0">
    <% @mac_guffins.each_with_index do |mac_guffin, index| %>
      <div class="flex group bg-white text-slate-900 shadow-slate-600 shadow-xl rounded-md hover:no-underline! focus:outline-hidden focus:ring-2 focus:ring-amber-400">
        <div class="w-24 flex-none p-3 bg-slate-900 border border-r-0 border-slate-950 rounded-l-md">
          <%= image_tag "https://picsum.photos/96?random=#{index}", class: "bg-white p-1 pb-4 shadow-slate-700 shadow-md rounded-xs sepia-50 rotate-2", size: "96x96", alt: mac_guffin.name %>
        </div>

        <div class="relative flex-1 p-2 border border-l-0 border-slate-300 rounded-r-md">
          <p class="text-slate-600 tracking-tight font-semibold select-none"><%= mac_guffin.name %></p>
          <div class="mb-2 border-t border-slate-300"></div>
          <p class="mb-10 text-sm justified select-none"><%= mac_guffin.description %></p>

          <span class="absolute bottom-2 inline-flex items-center rounded-md bg-gray-400/10 mt-4 px-2 py-1 text-xs font-medium text-gray-400 inset-ring inset-ring-gray-400/20 select-none">
            <%= fas_icon("eye") %>
            <span class="ml-1 capitalize"><%= mac_guffin.pretty_visibility %></span>
          </span>

          <% likes_count = @mac_guffin_like_counts.fetch(mac_guffin.id, 0) %>
          <% liked = @liked_mac_guffin_ids.include?(mac_guffin.id) %>

          <div class="absolute bottom-2 right-2">
            <% if current_user.nil? %>
              <%= link_to auth_sign_in_path, class: "inline-flex items-center gap-1 rounded-md bg-rose-50 px-2 py-1 text-xs font-medium text-rose-700 ring-1 ring-rose-300 hover:no-underline hover:bg-rose-100", title: "Sign in to like" do %>
                <%= fas_icon("heart") %>
                <span><%= likes_count %></span>
              <% end %>
            <% elsif current_user == mac_guffin.user %>
              <span class="inline-flex items-center gap-1 rounded-md bg-slate-100 px-2 py-1 text-xs font-medium text-slate-500 ring-1 ring-slate-300 select-none" title="You can't like your own MacGuffin">
                <%= fas_icon("heart") %>
                <span><%= likes_count %></span>
              </span>
            <% elsif liked %>
              <%= button_to demo_mac_guffin_like_path(mac_guffin),
                            method: :delete,
                            class: "inline-flex items-center gap-1 rounded-md bg-rose-600 px-2 py-1 text-xs font-medium text-white ring-1 ring-rose-700 cursor-pointer hover:bg-rose-700" do %>
                <%= fas_icon("heart") %>
                <span><%= likes_count %></span>
              <% end %>
            <% else %>
              <%= button_to demo_mac_guffin_like_path(mac_guffin),
                            method: :post,
                            class: "inline-flex items-center gap-1 rounded-md bg-white px-2 py-1 text-xs font-medium text-rose-700 ring-1 ring-rose-300 cursor-pointer hover:bg-rose-50" do %>
                <%= far_icon("heart") %>
                <span><%= likes_count %></span>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% if @mac_guffins.empty? %>
    <p class="mx-4 sm:mx-0 mt-8 text-sm text-center text-white italic">No MacGuffins matched your search</p>
  <% elsif @pagy.pages > 1 %>
    <div class="mx-4 sm:mx-0 mt-4 flex justify-center">
      <%== @pagy.series_nav %>
    </div>
  <% end %>
<% end %>
